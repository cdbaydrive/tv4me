<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IPTV Playlist Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/clusterize.js@0.18.1/clusterize.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-md p-6">
    <h1 class="text-2xl font-bold mb-4 text-center">IPTV Playlist Viewer</h1>

    <!-- Mode Toggle -->
    <div class="flex justify-center gap-2 mb-4">
      <button id="m3uBtn" class="px-4 py-2 rounded-l bg-blue-600 text-white">M3U URL</button>
      <button id="xtreamBtn" class="px-4 py-2 rounded-r bg-gray-200 text-black">Xtream Login</button>
    </div>

    <!-- M3U URL Form -->
    <div id="m3uForm" class="mb-4">
      <input type="text" id="m3uUrl" placeholder="Enter M3U URL" class="border p-2 w-full mb-2">
      <button class="bg-green-600 text-white px-4 py-2 rounded" onclick="fetchM3U()">Fetch Playlist</button>
      <button class="bg-yellow-500 text-white px-4 py-2 rounded ml-2" onclick="loadFromStorage()">Load Cached</button>
    </div>

    <!-- Xtream Form -->
    <div id="xtreamForm" class="hidden mb-4">
      <input type="text" id="xtreamUrl" placeholder="Base URL" class="border p-2 w-full mb-2">
      <input type="text" id="xtreamUser" placeholder="Username" class="border p-2 w-full mb-2">
      <input type="password" id="xtreamPass" placeholder="Password" class="border p-2 w-full mb-2">
      <button class="bg-green-600 text-white px-4 py-2 rounded" onclick="loadXtream()">Login</button>
    </div>

    <!-- Status Bar -->
    <div id="statusBar" class="text-center text-sm text-gray-600 mb-2"></div>

    <!-- Filters -->
    <div id="filters" class="hidden mb-4">
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-2">
        <select id="languageFilter" class="p-2 border rounded" onchange="applyFilters()">
          <option value="all">Language</option>
        </select>
        <select id="channelFilter" class="p-2 border rounded" onchange="applyFilters()">
          <option value="all">Channel</option>
        </select>
        <select id="qualityFilter" class="p-2 border rounded" onchange="applyFilters()">
          <option value="all">Quality</option>
        </select>
        <select id="yearFilter" class="p-2 border rounded" onchange="applyFilters()">
          <option value="all">Year</option>
        </select>
        <input type="text" id="search" placeholder="Search title..." class="p-2 border rounded" oninput="debouncedFilter()">
      </div>
    </div>

    <!-- Playlist Display with Clusterize.js -->
    <div id="playlistWrapper" class="border rounded h-[500px] overflow-auto">
      <table class="table-auto w-full text-sm">
        <tbody id="playlistContent" class="clusterize-content"></tbody>
      </table>
    </div>

    <!-- Player -->
    <div id="playerContainer" class="hidden fixed bottom-4 right-4 w-80 bg-black rounded shadow-lg">
      <video id="videoPlayer" controls class="w-full h-48 rounded"></video>
    </div>
  </div>

  <script>
    let allChannels = [], filteredChannels = [], favorites = new Set();
    let clusterize = new Clusterize({
      rows: [],
      scrollId: 'playlistWrapper',
      contentId: 'playlistContent'
    });

    const statusBar = document.getElementById('statusBar');
    const filtersDiv = document.getElementById('filters');
    const m3uUrlInput = document.getElementById('m3uUrl');

    function setStatus(msg, isError = false) {
      statusBar.textContent = msg;
      statusBar.className = text-center text-sm ${isError ? 'text-red-600' : 'text-gray-600'} mb-2;
    }

    function savePlaylist(url, data) {
      localStorage.setItem('playlistURL', url);
      localStorage.setItem('playlistData', JSON.stringify(data));
    }

    function loadFromStorage() {
      const data = localStorage.getItem('playlistData');
      const url = localStorage.getItem('playlistURL');
      if (data) {
        m3uUrlInput.value = url;
        allChannels = JSON.parse(data);
        populateFilters();
        applyFilters();
        setStatus('Loaded from cache');
      } else {
        setStatus('No cached data found', true);
      }
    }

    async function fetchM3U() {
      const url = m3uUrlInput.value;
      if (!url) return alert('Enter M3U URL');

      setStatus('Connecting to server...');
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Connection failed');

        setStatus('Fetching playlist...');
        const text = await res.text();
        setStatus('Parsing playlist...');

        allChannels = parseM3U(text);
        savePlaylist(url, allChannels);
        populateFilters();
        applyFilters();
        setStatus(Loaded ${allChannels.length} channels);
        filtersDiv.classList.remove('hidden');
      } catch (e) {
        setStatus(Error: ${e.message}, true);
      }
    }

    function parseM3U(text) {
      const lines = text.split('\n');
      const channels = [];
      let current = {};
      for (let line of lines) {
        line = line.trim();
        if (line.startsWith('#EXTINF')) {
          const nameMatch = line.match(/,(.*)/);
          const groupMatch = line.match(/group-title="(.*?)"/i);
          const yearMatch = line.match(/year=(\d{4})/i);
          current = {
            name: nameMatch ? nameMatch[1] : 'Unknown',
            group: groupMatch ? groupMatch[1] : 'Other',
            language: /\bFR\b/i.test(line) ? 'FR' : /\bEN\b/i.test(line) ? 'EN' : 'Other',
            quality: /UHD|4K/i.test(line) ? 'UHD' : /FHD|1080p/i.test(line) ? 'FHD' : /HD|720p/i.test(line) ? 'HD' : /SD|480p/i.test(line) ? 'SD' : 'Unknown',
            year: yearMatch ? yearMatch[1] : 'Unknown'
          };
        } else if (line && !line.startsWith('#')) {
          current.url = line;
          current.favorite = false;
          channels.push({ ...current });
        }
      }
      return channels;
    }

    function populateFilters() {
      const langSet = new Set(), chanSet = new Set(), qualSet = new Set(), yearSet = new Set();
      allChannels.forEach(ch => {
        langSet.add(ch.language);
        chanSet.add(ch.group);
        qualSet.add(ch.quality);
        yearSet.add(ch.year);
      });

      populateDropdown('languageFilter', langSet);
      populateDropdown('channelFilter', chanSet);
      populateDropdown('qualityFilter', qualSet);
      populateDropdown('yearFilter', yearSet);
    }

    function populateDropdown(id, values) {
      const el = document.getElementById(id);
      el.innerHTML = '<option value="all">' + el.options[0].textContent + '</option>';
      Array.from(values).sort().forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        el.appendChild(opt);
      });
    }

    function applyFilters() {
      const lang = document.getElementById('languageFilter').value;
      const chan = document.getElementById('channelFilter').value;
      const qual = document.getElementById('qualityFilter').value;
      const year = document.getElementById('yearFilter').value;
      const query = document.getElementById('search').value.toLowerCase();

      filteredChannels = allChannels.filter(ch =>
        (lang === 'all' || ch.language === lang) &&
        (chan === 'all' || ch.group === chan) &&
        (qual === 'all' || ch.quality === qual) &&
        (year === 'all' || ch.year === year) &&
        ch.name.toLowerCase().includes(query)
      );

      clusterize.update(filteredChannels.map(renderRow));
    }

    function renderRow(ch, idx) {
      return `<tr class="border-b hover:bg-gray-100">
        <td class="p-2">${ch.name}</td>
        <td class="p-2 text-right">
          <button onclick="toggleFavorite(${idx})">${ch.favorite ? '★' : '☆'}</button>
          <button onclick="playStream('${ch.url}')" class="ml-2 text-blue-600 text-xs">Play</button>
        </td>
      </tr>`;
    }

    function toggleFavorite(idx) {
      filteredChannels[idx].favorite = !filteredChannels[idx].favorite;
      applyFilters();
    }

    function playStream(url) {
      const player = document.getElementById('videoPlayer');
      const container = document.getElementById('playerContainer');
      container.classList.remove('hidden');
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player);
      } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src = url;
      }
      player.play();
    }

    function debouncedFilter() {
      clearTimeout(window.filterTimer);
      window.filterTimer = setTimeout(applyFilters, 300);
    }

    window.onload = () => {
      const savedURL = localStorage.getItem('playlistURL');
      if (savedURL) m3uUrlInput.value = savedURL;
    };
  </script>
</body>
</html>
