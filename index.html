<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IPTV Playlist Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .star {
      cursor: pointer;
      font-size: 1.2rem;
    }
    #playlistScroll {
      height: calc(100vh - 320px);
      overflow-y: auto;
      scroll-behavior: smooth;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="w-full bg-white rounded-2xl shadow-md p-6">
    <h1 class="text-2xl font-bold mb-2 text-center">IPTV Playlist Viewer</h1>
    <p class="text-gray-500 text-xs text-center mb-4">Version 1.1.2</p>

    <!-- M3U Fetch -->
    <div class="flex flex-wrap gap-2 mb-4">
      <input type="text" id="m3uUrl" placeholder="Enter M3U URL" class="flex-grow border p-2 rounded" />
      <button class="bg-green-600 text-white px-4 py-2 rounded" onclick="fetchM3U()">Fetch Playlist</button>
    </div>

    <!-- Buttons -->
    <div class="flex flex-wrap gap-2 items-center mb-4">
      <button class="bg-orange-500 text-white px-4 py-2 rounded" onclick="exportPlaylistAsM3U()">Download Playlist</button>
      <label class="cursor-pointer bg-blue-500 text-white px-4 py-2 rounded">
        Upload Playlist
        <input type="file" id="uploadM3U" accept=".m3u" class="hidden" onchange="handleM3UUpload(event)" />
      </label>
    </div>

    <!-- Search -->
    <div class="mb-4">
      <input type="text" id="searchInput" placeholder="Search channels..." class="border p-2 w-full rounded" />
    </div>

    <!-- Filters + Favorites -->
    <div class="flex flex-wrap gap-2 items-center mb-4">
      <div class="flex gap-2 flex-grow w-full">
        <select id="languageFilter" class="p-2 border rounded w-1/4">
          <option value="">Filter by Language</option>
        </select>
        <select id="qualityFilter" class="p-2 border rounded w-1/4">
          <option value="">Filter by Quality</option>
        </select>
        <select id="yearFilter" class="p-2 border rounded w-1/4">
          <option value="">Filter by Year</option>
        </select>
        <select id="typeFilter" class="p-2 border rounded w-1/4">
          <option value="">Filter by Type</option>
        </select>
      </div>
      <button id="toggleFavoritesBtn" class="ml-auto bg-yellow-400 text-black px-4 py-2 rounded">Favorites</button>
    </div>

    <!-- Playlist Display -->
    <div id="playlistScroll" class="bg-gray-50 border rounded p-2">
      <div id="playlistDisplay" class="space-y-2"></div>
    </div>
  </div>

  <script>
    let currentPlaylist = [];
    let filteredPlaylist = [];
    let favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
    let showingFavorites = false;
    let rowHeight = 32;
    let visibleCount = 100;

    document.getElementById("searchInput").addEventListener("input", debounce(applyFilters, 300));
    document.getElementById("languageFilter").addEventListener("change", applyFilters);
    document.getElementById("qualityFilter").addEventListener("change", applyFilters);
    document.getElementById("yearFilter").addEventListener("change", applyFilters);
    document.getElementById("typeFilter").addEventListener("change", applyFilters);
    document.getElementById("toggleFavoritesBtn").addEventListener("click", () => {
      showingFavorites = !showingFavorites;
      document.getElementById("toggleFavoritesBtn").textContent = showingFavorites ? "Back to Playlist" : "Favorites";
      applyFilters();
    });
    document.getElementById("playlistScroll").addEventListener("scroll", () => {
      requestAnimationFrame(renderVisibleRows);
    });

    function fetchM3U() {
      const url = document.getElementById("m3uUrl").value.trim();
      if (!url) return alert("Please enter a URL.");

      fetch(url)
        .then((res) => res.text())
        .then((data) => parseM3U(data))
        .catch((err) => {
          console.error("Fetch error:", err);
          alert("Failed to fetch playlist.");
        });
    }

    function parseM3U(text) {
      const lines = text.split("\n");
      const channels = [];
      let current = {};
      for (let line of lines) {
        line = line.trim();
        if (line.startsWith("#EXTINF")) {
          const nameMatch = line.match(/,(.*)/);
          const groupMatch = line.match(/group-title="(.*?)"/i);
          const yearMatch = line.match(/year="(\d{4})"/i) || line.match(/(?:^|\D)((?:19|20)\d{2})(?:\D|$)/);
          const name = nameMatch ? nameMatch[1] : "Unknown";
          const group = groupMatch ? groupMatch[1] : "Other";
          const year = yearMatch ? yearMatch[1] : "";

          let type = "Channel";
          if (/movie|film/i.test(group) || /\bmovie\b/i.test(name)) type = "Movie";
          else if (/series|show/i.test(group) || /\bS\d{1,2}E\d{1,2}\b/i.test(name)) type = "Series";

          current = { name, group, year, type };
        } else if (line && !line.startsWith("#")) {
          current.url = line;
          channels.push({ ...current });
        }
      }
      currentPlaylist = channels;
      populateFilters(channels);
      applyFilters();
    }

    function populateFilters(channels) {
      const langSelect = document.getElementById("languageFilter");
      const qualSelect = document.getElementById("qualityFilter");
      const typeSelect = document.getElementById("typeFilter");

      const langs = new Set();
      const quals = new Set();
      const types = new Set();

      channels.forEach((ch) => {
        const langMatch = ch.name.match(/^([A-Z]{2})[:\s-]/);
        const lang = langMatch ? langMatch[1] : "Other";
        langs.add(lang);

        if (/UHD|4K/i.test(ch.name)) quals.add("UHD");
        else if (/FHD|1080p/i.test(ch.name)) quals.add("FHD");
        else if (/HD|720p/i.test(ch.name)) quals.add("HD");
        else if (/SD|480p/i.test(ch.name)) quals.add("SD");
        else quals.add("Unknown");

        types.add(ch.type);
      });

      const langList = Array.from(langs).sort((a, b) => {
        if (a === "FR" || a === "EN") return -1;
        if (b === "FR" || b === "EN") return 1;
        return a.localeCompare(b);
      });

      langSelect.innerHTML = '<option value="">Filter by Language</option>' + langList.map(l => `<option value="${l}">${l}</option>`).join('');
      qualSelect.innerHTML = '<option value="">Filter by Quality</option>' + Array.from(quals).sort().map(q => `<option value="${q}">${q}</option>`).join('');
      typeSelect.innerHTML = '<option value="">Filter by Type</option>' + Array.from(types).sort().map(t => `<option value="${t}">${t}</option>`).join('');
    }

    function updateYearFilterOptions(channels) {
      const yearSelect = document.getElementById("yearFilter");
      const years = new Set();
      channels.forEach((ch) => {
        if (ch.year && /^\d{4}$/.test(ch.year)) years.add(ch.year);
      });
      const sortedYears = Array.from(years).sort((a, b) => b - a);
      yearSelect.innerHTML = '<option value="">Filter by Year</option>' + sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    function applyFilters() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const lang = document.getElementById("languageFilter").value;
      const qual = document.getElementById("qualityFilter").value;
      const year = document.getElementById("yearFilter").value;
      const type = document.getElementById("typeFilter").value;

      filteredPlaylist = currentPlaylist.filter((ch) => {
        const matchesSearch = ch.name.toLowerCase().includes(search);
        const matchesLang = !lang || ch.name.startsWith(lang);
        const matchesQual = !qual || (
          (qual === 'UHD' && /UHD|4K/i.test(ch.name)) ||
          (qual === 'FHD' && /FHD|1080p/i.test(ch.name)) ||
          (qual === 'HD' && /HD|720p/i.test(ch.name)) ||
          (qual === 'SD' && /SD|480p/i.test(ch.name)) ||
          (qual === 'Unknown' && !/(UHD|FHD|HD|SD|4K|1080p|720p|480p)/i.test(ch.name))
        );
        const matchesYear = !year || ch.year === year;
        const matchesType = !type || ch.type === type;
        return matchesSearch && matchesLang && matchesQual && matchesYear && matchesType;
      });

      if (showingFavorites) {
        filteredPlaylist = filteredPlaylist.filter(ch => favorites.includes(ch.url));
      }

      updateYearFilterOptions(filteredPlaylist);
      renderVisibleRows();
    }

    function renderVisibleRows() {
      const scrollTop = document.getElementById("playlistScroll").scrollTop;
      const start = Math.max(0, Math.floor(scrollTop / rowHeight) - 5);
      const end = start + visibleCount + 10;

      const display = document.getElementById("playlistDisplay");
      display.innerHTML = "";

      for (let i = start; i < Math.min(end, filteredPlaylist.length); i++) {
        const ch = filteredPlaylist[i];
        const isFavorite = favorites.includes(ch.url);
        const div = document.createElement("div");
        div.className = "flex justify-between items-center border-b py-1 text-sm";
        div.innerHTML = `
          <span class="truncate">${ch.name}</span>
          <div class="flex items-center gap-2">
            <span class="star" onclick="toggleFavorite('${ch.url}')">${isFavorite ? '★' : '☆'}</span>
            <a href="${ch.url}" target="_blank" class="text-blue-600 text-xs">Play</a>
          </div>
        `;
        display.appendChild(div);
      }
    }

    function toggleFavorite(url) {
      const idx = favorites.indexOf(url);
      if (idx >= 0) favorites.splice(idx, 1);
      else favorites.push(url);
      localStorage.setItem("favorites", JSON.stringify(favorites));
      applyFilters();
    }

    function handleM3UUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => parseM3U(e.target.result);
      reader.readAsText(file);
    }

    function exportPlaylistAsM3U() {
      if (!currentPlaylist.length) return alert("No playlist to export.");
      let content = "#EXTM3U\n";
      currentPlaylist.forEach(ch => {
        content += `#EXTINF:-1 group-title="${ch.group}"${ch.year ? ` year="${ch.year}"` : ''},${ch.name}\n${ch.url}\n`;
      });
      const blob = new Blob([content], { type: "audio/x-mpegurl" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "playlist.m3u";
      a.click();
    }

    function debounce(fn, delay) {
      let timer;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }
  </script>
</body>
</html>
