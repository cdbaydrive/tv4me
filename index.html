<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IPTV Playlist Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-md p-6">
    <h1 class="text-2xl font-bold mb-4 text-center">IPTV Playlist Viewer</h1>

    <!-- Mode Toggle -->
    <div class="flex justify-center gap-2 mb-4">
      <button id="m3uBtn" class="px-4 py-2 rounded-l bg-blue-600 text-white">M3U URL</button>
      <button id="xtreamBtn" class="px-4 py-2 rounded-r bg-gray-200 text-black">Xtream Login</button>
    </div>

    <!-- M3U URL Form -->
    <div id="m3uForm" class="mb-4">
      <input type="text" id="m3uUrl" placeholder="Enter M3U URL" class="border p-2 w-full mb-2">
      <div class="flex gap-2">
        <button onclick="fetchM3U()" class="bg-green-600 text-white px-4 py-2 rounded">Fetch Playlist</button>
        <button onclick="loadSavedPlaylist()" class="bg-blue-500 text-white px-4 py-2 rounded">Load Saved Playlist</button>
      </div>
    </div>

    <!-- Xtream Form -->
    <div id="xtreamForm" class="hidden mb-4">
      <input type="text" id="xtreamUrl" placeholder="Base URL" class="border p-2 w-full mb-2">
      <input type="text" id="xtreamUser" placeholder="Username" class="border p-2 w-full mb-2">
      <input type="password" id="xtreamPass" placeholder="Password" class="border p-2 w-full mb-2">
      <button class="bg-green-600 text-white px-4 py-2 rounded" onclick="loadXtream()">Login</button>
    </div>

    <!-- Filters -->
    <div id="filters" class="hidden mb-4">
      <input type="text" id="search" placeholder="Search title..." class="p-2 border rounded w-full mb-2" oninput="applyFilters()">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
        <select id="groupBy" class="p-2 border rounded" onchange="applyFilters()">
          <option value="group">Group</option>
          <option value="location">Location</option>
          <option value="channel">Channel</option>
          <option value="quality">Quality</option>
        </select>
      </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="text-center text-blue-500 font-semibold hidden mb-4">Fetching playlist...</div>

    <!-- Display Area -->
    <div id="playlistDisplay" class="space-y-4"></div>

    <!-- Player -->
    <div id="playerContainer" class="hidden fixed bottom-4 right-4 w-80 bg-black rounded shadow-lg">
      <video id="videoPlayer" controls class="w-full h-48 rounded"></video>
    </div>
  </div>

  <script>
    let allChannels = [];
    let currentGroupBy = 'group';

    const loader = document.getElementById('loader');
    const filters = document.getElementById('filters');
    const display = document.getElementById('playlistDisplay');
    const groupBySelect = document.getElementById('groupBy');

    function showStep(message, isError = false) {
      loader.textContent = message;
      loader.classList.remove('hidden');
      loader.classList.toggle('text-red-500', isError);
      loader.classList.toggle('text-blue-500', !isError);
    }

    async function fetchM3U() {
      const urlInput = document.getElementById('m3uUrl');
      let url = urlInput.value.trim();
      if (!url) return alert('Enter M3U URL');

      showStep('Connecting to server...');
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(HTTP error! Status: ${res.status});
        showStep('Fetching playlist...');
        const text = await res.text();

        if (!text.includes('#EXTINF')) throw new Error('Invalid playlist format');

        allChannels = parseM3U(text);
        savePlaylistToLocal(url, text);
        filters.classList.remove('hidden');
        showStep('Parsing and displaying...');
        applyFilters();

        showStep('✅ Playlist loaded successfully');
      } catch (e) {
        console.error('Fetch failed:', e);
        showStep('❌ Failed to fetch playlist. Trying proxy...', true);

        try {
          const proxiedUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
          const res = await fetch(proxiedUrl);
          if (!res.ok) throw new Error(Proxy error! Status: ${res.status});
          const text = await res.text();

          if (!text.includes('#EXTINF')) throw new Error('Invalid playlist format via proxy');

          allChannels = parseM3U(text);
          savePlaylistToLocal(url, text);
          filters.classList.remove('hidden');
          showStep('✅ Playlist loaded using proxy');
          applyFilters();
        } catch (proxyError) {
          console.error('Proxy fetch failed:', proxyError);
          showStep('❌ Failed to load playlist even via proxy.', true);
        }
      }
    }

    function savePlaylistToLocal(url, content) {
      localStorage.setItem('savedPlaylistUrl', url);
      localStorage.setItem('savedPlaylistData', content);
    }

    function loadSavedPlaylist() {
      const data = localStorage.getItem('savedPlaylistData');
      if (!data) {
        alert('No saved playlist found. Please fetch one first.');
        return;
      }
      showStep('Loading saved playlist...');
      allChannels = parseM3U(data);
      filters.classList.remove('hidden');
      applyFilters();
      showStep('✅ Loaded saved playlist');
    }

    function parseM3U(text) {
      const lines = text.split('\n');
      const channels = [];
      let current = {};
      for (let line of lines) {
        line = line.trim();
        if (line.startsWith('#EXTINF')) {
          const nameMatch = line.match(/,(.*)/);
          const groupMatch = line.match(/group-title="(.*?)"/i);
          const tvgType = line.includes('catchup') ? 'vod' : 'live';
          current = {
            name: nameMatch ? nameMatch[1] : 'Unknown',
            group: groupMatch ? groupMatch[1] : 'Other',
            type: tvgType
          };
        } else if (line && !line.startsWith('#')) {
          current.url = line;
          channels.push({ ...current });
        }
      }
      return channels;
    }

    function applyFilters() {
      const query = document.getElementById('search').value.toLowerCase();
      const groupBy = groupBySelect.value;

      let filtered = allChannels.filter(c =>
        c.name.toLowerCase().includes(query)
      );

      const groups = {};
      filtered.forEach(ch => {
        let key = groupKey(ch, groupBy);
        if (!groups[key]) groups[key] = [];
        groups[key].push(ch);
      });

      display.innerHTML = '';
      Object.entries(groups).forEach(([group, chs]) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'bg-gray-50 p-4 rounded shadow';
        const title = document.createElement('h2');
        title.className = 'text-xl font-semibold mb-2';
        title.textContent = group;
        groupDiv.appendChild(title);

        chs.forEach(ch => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center border-b py-1 text-sm';
          div.innerHTML = `
            <span>${ch.name} <span class="ml-2 text-xs text-gray-400">(${ch.type.toUpperCase()})</span></span>
            <button onclick="playStream('${ch.url}')" class="text-blue-600 text-xs">Play</button>
          `;
          groupDiv.appendChild(div);
        });

        display.appendChild(groupDiv);
      });
    }

    function groupKey(ch, mode) {
      switch (mode) {
        case 'location':
          const loc = ch.name.match(/^([A-Z]{2})[:\s-]/);
          return loc ? loc[1] : 'Other';
        case 'channel':
          return ch.name.replace(/HD|FHD|UHD|4K|SD|\d{3,4}p/gi, '').trim();
        case 'quality':
          if (/UHD|4K/i.test(ch.name)) return 'UHD';
          if (/FHD|1080p/i.test(ch.name)) return 'FHD';
          if (/HD|720p/i.test(ch.name)) return 'HD';
          if (/SD|480p/i.test(ch.name)) return 'SD';
          return 'Unknown';
        default:
          return ch.group || 'Other';
      }
    }

    function playStream(url) {
      const player = document.getElementById('videoPlayer');
      const container = document.getElementById('playerContainer');
      container.classList.remove('hidden');
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player);
      } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src = url;
      }
      player.play();
    }
  </script>
</body>
</html>
